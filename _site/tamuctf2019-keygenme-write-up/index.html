<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/post.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/scroll.css">
  <link rel="stylesheet" href="/css/typewriter.css">
  <link rel="stylesheet" href="/fontawesome/css/all.min.css">
  <title>My pentest notes</title>
</head>
<body>


<div class="header">
  <div>
    <h3><span class="typewriter">My pentest notes</span></h3>
  </div>
</div>

<div class="nav">
  <ul class="text-source">
    <li> <a href="/">HOME</a> </li>
    <li> <a href="\list">POSTS</a> </li>
  </ul>
</div>


<div class="row">
  <div class="leftcolumn">
    <div class="card">
  <h2 class="text-source">About Me</h2>
  <ul class="list-none">
    <li><i class="fas fa-user mb-08"></i> DanP</li>
    <li><i class="fas fa-map-marker-alt mb-08"></i> Brazil</li>
    <li><i class="fas fa-envelope mb-08"></i> 
    	<a class="decoration-none text-white" target="_blank" href="mailto:soaresdaniel487@gmail.com"> E-mail </a> 
    </li>
    <li><i class="fab fa-github"></i> <a class="decoration-none text-white" href="https://github.com/D4nPs" target="_blank">Github</a> </li>
  </ul>
</div>

    <div class="mt-2">
    <h4  class="text-white" style="padding-left: 25px">Share this:</h4>
    <div id="share-bar">

    <!-- <h5>Share this:</h5> -->

    <div class="share-buttons text-center">
        <a style="text-decoration: none;" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/tamuctf2019-keygenme-write-up/"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on Facebook" >
            <i class="fab fa-facebook share-button"></i>
        </a>

        <a style="text-decoration: none;" href="https://twitter.com/intent/tweet?text=TAMUCTF2019 Keygenme — Write-up&url=http://localhost:4000/tamuctf2019-keygenme-write-up/"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on Twitter" >
            <i class="fab fa-twitter share-button"></i>
        </a>

        <a style="text-decoration: none;" href="http://www.reddit.com/submit?url=http://localhost:4000/tamuctf2019-keygenme-write-up/"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on Reddit" >
            <i class="fab fa-reddit-alien share-button"></i>
        </a>

        <a style="text-decoration: none;" href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/tamuctf2019-keygenme-write-up/&title=TAMUCTF2019 Keygenme — Write-up&summary=Hello everybody! This is how I solved one of the many reversing problems at TAMUCTF 2019.&source=My pentest notes"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on LinkedIn" >
            <i class="fab fa-linkedin share-button"></i>
        </a>

        <a style="text-decoration: none;" href="mailto:?subject=TAMUCTF2019 Keygenme — Write-up&amp;body=Check out this site http://localhost:4000/tamuctf2019-keygenme-write-up/"
            title="Share via Email" >
            <i class="fa fa-envelope share-button"></i>
        </a>
    </div>

</div>
    </div>
  </div>

  <div class="rightcolumn">
    <div class="card box-content">
    	
      <h2 class="text-source text-blue"> TAMUCTF2019 Keygenme — Write-up </h2>
<h5> Hello everybody! This is how I solved one of the many reversing problems at TAMUCTF 2019. </h5>
<h5> May, 3 2019 </h5>


      <p>Hello everybody! This is how I solved one of the many reversing problems at TAMUCTF 2019.</p>

<p>This one was Keygenme, a pretty standard kind of challenge but yet very fun to solve it.</p>

<p>Let’s go!</p>

<p class="text-center"><img src="/img/jekyll/1/ratf.png" alt="ratf" class="img-responsive" /></p>

<p class="text-center"><img src="/img/jekyll/4/code.png" alt="ratf" class="img-responsive" /></p>

<p>Let’s start by running the binary that was given to us and see what it says.</p>

<p class="text-center"><img src="/img/jekyll/4/code1.png" alt="ratf" class="img-responsive" /></p>

<p>Basically, when we run the binary it asks for a product key and if we give an incorrect one it simply shuts itself down. Then I searched for the strings inside the binary, sometimes they help us understand what the program is doing.</p>

<p class="text-center"><img src="/img/jekyll/4/code2.png" alt="ratf" class="img-responsive" /></p>

<p>By using rabin2 I was able to identify all the strings in the binary, all of them are very important so let’s take a look at them one by one</p>

<figure class="highlight"><pre><code class="language-cmd" data-lang="cmd">	[OIonU2_&lt;__nK&lt;KsK</code></pre></figure>

<p>A pretty odd string that at the start don’t get our attention as the others, but it’s gonna be important in a moment.</p>

<figure class="highlight"><pre><code class="language-cmd" data-lang="cmd">\nPlease Enter a product key to continue:</code></pre></figure>

<p>That’s the string we just saw.</p>

<figure class="highlight"><pre><code class="language-cmd" data-lang="cmd">flag.txt</code></pre></figure>

<p>A string that everybody likes to see, but I don’t have a flag.txt? Do you?</p>

<figure class="highlight"><pre><code class="language-cmd" data-lang="cmd">Too bad the flag is only on the remote server!</code></pre></figure>

<p>String, even if we bypassed the checking functions using the disassembler locally we would not be able to retrieve our flag because it’s been hosted remotely.</p>

<p>So with this quick overview of the strings, we now know that we have to create our own keygen to beat this challenge.</p>

<p class="text-center"><img src="/img/jekyll/4/code3.png" alt="ratf" class="img-responsive" /></p>

<p>Analyzing the binary with hopper disassembler there are 3 functions that get our attention</p>

<figure class="highlight"><pre><code class="language-cmd" data-lang="cmd">0x92a P enc
0x9da P verify_key
0xa46 P main</code></pre></figure>

<p>It’s pretty clear what each function is doing so I’m gonna skip that whole explanation and focus on the verify_key function first.</p>

<p class="text-center"><img src="/img/jekyll/4/code4.png" alt="ratf" class="img-responsive" /></p>

<p>That part is at the beginning of the function verify_key and its job is to get our input, our “KEY”, and checks if its size is bigger than 0x9 in hexa aka 9 in decimal xd.</p>

<p>So, important information, we must supply a key that is longer than 9 digits, noted.</p>

<p>Right after this block, there’s a check to see if our input is larger than 0x40 bytes, since we will no be providing a key this long, I’m gonna skip it.</p>

<p class="text-center"><img src="/img/jekyll/4/code5.png" alt="ratf" class="img-responsive" /></p>

<p>There are a few import things we must consider on this part of the function.</p>

<ol>
	<li>The enc function is called by verify_key and not by main.</li>
	<li>Right after enc function is called our modified key is compared to [OIonU2_&lt;__nK&lt;KsK
	</li>
</ol>

<p>Now it’s clear that we have to provide some input that after it passes the enc function it has to be equal to that strange string we saw early on.</p>

<p>Now we have to go through the enc function and figure what it is doing with our input and reverse it.</p>

<figure class="highlight"><pre><code class="language-cmd" data-lang="cmd">0000000000000960         mov        eax, dword [rbp+var_10]    ; CODE XREF=enc+168
0000000000000963         movsxd     rdx, eax
0000000000000966         mov        rax, qword [rbp+var_28]
000000000000096a         add        rax, rdx
000000000000096d         movzx      eax, byte [rax]
0000000000000970         movsx      eax, al
0000000000000973         lea        edx, dword [rax+0xc]
0000000000000976         movzx      eax, byte [rbp+var_11]
000000000000097a         imul       eax, edx
000000000000097d         lea        ecx, dword [rax+0x11]
0000000000000980         mov        edx, 0xea0ea0eb
0000000000000985         mov        eax, ecx
0000000000000987         imul       edx
0000000000000989         lea        eax, dword [rdx+rcx]
000000000000098c         sar        eax, 0x6
000000000000098f         mov        edx, eax
0000000000000991         mov        eax, ecx
0000000000000993         sar        eax, 0x1f
0000000000000996         sub        edx, eax
0000000000000998         mov        eax, edx
000000000000099a         imul       eax, eax, 0x46
000000000000099d         sub        ecx, eax
000000000000099f         mov        eax, ecx
00000000000009a1         lea        ecx, dword [rax+0x30]
00000000000009a4         mov        eax, dword [rbp+var_10]
00000000000009a7         movsxd     rdx, eax
00000000000009aa         mov        rax, qword [rbp+var_8]
00000000000009ae         add        rax, rdx
00000000000009b1         mov        edx, ecx
00000000000009b3         mov        byte [rax], dl
00000000000009b5         mov        eax, dword [rbp+var_10]
00000000000009b8         movsxd     rdx, eax
00000000000009bb         mov        rax, qword [rbp+var_8]
00000000000009bf         add        rax, rdx
00000000000009c2         movzx      eax, byte [rax]
00000000000009c5         mov        byte [rbp+var_11], al
00000000000009c8         add        dword [rbp+var_10], 0x1
loc_9cc:
00000000000009cc         mov        eax, dword [rbp+var_10]         ; CODE XREF=enc+52
00000000000009cf         cmp        eax, dword [rbp+var_C]
00000000000009d2         jl         loc_960</code></pre></figure>

<p>using this part and the hopper pseudo code:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">enc</span><span class="p">(</span><span class="kt">int</span> <span class="n">arg0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">var_28</span> <span class="o">=</span> <span class="n">arg0</span><span class="p">;</span>
    <span class="n">var_8</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x40</span><span class="p">);</span>
    <span class="n">var_C</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">var_28</span><span class="p">);</span>
    <span class="n">var_11</span> <span class="o">=</span> <span class="mh">0x48</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">var_10</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="n">var_10</span> <span class="o">&lt;</span> <span class="n">var_C</span><span class="p">;</span> <span class="n">var_10</span> <span class="o">=</span> <span class="n">var_10</span> <span class="o">+</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">rcx</span> <span class="o">=</span> <span class="p">(</span><span class="n">var_11</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">sign_extend_64</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">int8_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">var_28</span> <span class="o">+</span> <span class="n">sign_extend_64</span><span class="p">(</span><span class="n">var_10</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x11</span><span class="p">;</span>
            <span class="o">*</span><span class="p">(</span><span class="kt">int8_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">var_8</span> <span class="o">+</span> <span class="n">sign_extend_64</span><span class="p">(</span><span class="n">var_10</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="n">rcx</span> <span class="o">-</span> <span class="p">((</span><span class="n">SAR</span><span class="p">(</span><span class="n">HIDWORD</span><span class="p">(</span><span class="n">rcx</span> <span class="o">*</span> <span class="mh">0xffffffffea0ea0eb</span><span class="p">)</span> <span class="o">+</span> <span class="n">rcx</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span><span class="n">SAR</span><span class="p">(</span><span class="n">rcx</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">)))</span> <span class="o">*</span> <span class="mh">0x46</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">;</span>
            <span class="n">var_11</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int8_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">var_8</span> <span class="o">+</span> <span class="n">sign_extend_64</span><span class="p">(</span><span class="n">var_10</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">rax</span> <span class="o">=</span> <span class="n">var_8</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">rax</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>I managed to write this whole process in python and I noticed that the next key’s value always depends on its previous neighbor. So to discover what key generates this [OIonU2_&lt;__nK&lt;KsK, I simply brute forced it XD.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#!/usr/bin/env python 
</span>
<span class="n">enckeyFINAL</span> <span class="o">=</span> <span class="s">"[OIonU2_&lt;__nK&lt;KsK"</span> <span class="c1">#G&gt;
</span><span class="n">base</span> <span class="o">=</span> <span class="mh">0x48</span>
<span class="n">flagfinal</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">flag2</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">cont</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">chars</span><span class="o">=</span> <span class="s">"'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz!#$</span><span class="si">%</span><span class="s">&amp;'()*+,-./0123456789:;&lt;=&gt;?@[]^_`{|}~'"</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
	<span class="k">try</span><span class="p">:</span>		
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chars</span><span class="p">)):</span>
			<span class="n">rcx</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span><span class="o">*</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">chars</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">))</span> <span class="o">+</span> <span class="mh">0x11</span>
			<span class="n">rax</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">rcx</span><span class="o">*</span><span class="mh">0xffffffffea0ea0eb</span><span class="p">)</span>
			<span class="n">rax</span> <span class="o">=</span> <span class="n">rax</span><span class="p">[</span><span class="o">-</span><span class="mi">17</span><span class="p">:]</span>
			<span class="n">rax</span> <span class="o">=</span> <span class="n">rax</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>
			<span class="n">rax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rax</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
			<span class="n">rax</span> <span class="o">+=</span> <span class="n">rcx</span>
			<span class="n">rax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">rax</span><span class="p">)[</span><span class="o">-</span><span class="mi">5</span><span class="p">:],</span><span class="mi">16</span><span class="p">)</span>
			<span class="n">rax</span> <span class="o">=</span> <span class="n">rax</span> <span class="o">&gt;&gt;</span> <span class="mh">0x6</span>
			<span class="n">ecx</span> <span class="o">=</span> <span class="n">rcx</span> <span class="o">&gt;&gt;</span> <span class="mh">0x1f</span>
			<span class="n">rax</span> <span class="o">*=</span> <span class="mh">0x46</span>
			<span class="n">rax</span> <span class="o">=</span> <span class="n">rcx</span> <span class="o">-</span> <span class="n">rax</span>
			<span class="n">rax</span> <span class="o">+=</span> <span class="mh">0x30</span>
			<span class="n">flag2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">rax</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">flag2</span> <span class="o">==</span> <span class="n">enckeyFINAL</span><span class="p">[</span><span class="n">cont</span><span class="p">]:</span>
				<span class="n">flagfinal</span> <span class="o">=</span> <span class="n">flagfinal</span> <span class="o">+</span> <span class="n">chars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
				<span class="n">cont</span> <span class="o">=</span> <span class="n">cont</span> <span class="o">+</span> <span class="mi">1</span>
				<span class="n">base</span> <span class="o">=</span> <span class="n">rax</span>
				<span class="k">if</span> <span class="n">cont</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
					<span class="k">break</span>
	<span class="k">except</span><span class="p">:</span>
    			<span class="k">break</span>
<span class="k">print</span> <span class="n">flagfinal</span>
		 
	

	</code></pre></figure>

<p class="text-center"><a href="https://gist.githubusercontent.com/D4nPs/7c71f549298b7e64101133b45df4cdeb/raw/94d7270e776c192477b23393f54b11a6244fa9c8/test.py">LINK BASE GITHUB</a></p>

<p>By running this script I got</p>

<figure class="highlight"><pre><code class="language-cmd" data-lang="cmd">GHZxSZcfov09&lt;GNRB</code></pre></figure>

<p>Let’s send to the server and get our FLAG!</p>

<p class="text-center"><img src="/img/jekyll/4/code6.png" alt="ratf" class="img-responsive" /></p>

<p>Well…Maybe not 😢.</p>

<p>Let’s use gdb-PEDA to find out why we did not get our deserved flag.</p>

<p>I set up a breakpoint right before my input and that awful string are compared and I got this.</p>

<p class="text-center"><img src="/img/jekyll/4/code7.png" alt="ratf" class="img-responsive" /></p>

<p>So the program adds this “\n” and I’m not sure why.</p>

<p>That thing made me wonder for a while why that’s there and how to bypass it.</p>

<p>Then I found the solution to be very simple (and a bit of luck maybe?). This “\n” is changing into “i” because it’s after a “B”, so I have to find a character that change “\n” into “K”.</p>

<p class="text-center"><img src="/img/jekyll/4/code8.png" alt="ratf" class="img-responsive" /></p>

<p>And the “R” was there all along to save me.</p>

<p class="text-center"><img src="/img/jekyll/4/code9.png" alt="ratf" class="img-responsive" /></p>

<p>Hope you guys enjoyed it!</p>

<p>by me</p>


      <div style="margin-top: 50px">
      <div id="share-bar">

    <!-- <h5>Share this:</h5> -->

    <div class="share-buttons text-center">
        <a style="text-decoration: none;" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/tamuctf2019-keygenme-write-up/"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on Facebook" >
            <i class="fab fa-facebook share-button"></i>
        </a>

        <a style="text-decoration: none;" href="https://twitter.com/intent/tweet?text=TAMUCTF2019 Keygenme — Write-up&url=http://localhost:4000/tamuctf2019-keygenme-write-up/"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on Twitter" >
            <i class="fab fa-twitter share-button"></i>
        </a>

        <a style="text-decoration: none;" href="http://www.reddit.com/submit?url=http://localhost:4000/tamuctf2019-keygenme-write-up/"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on Reddit" >
            <i class="fab fa-reddit-alien share-button"></i>
        </a>

        <a style="text-decoration: none;" href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/tamuctf2019-keygenme-write-up/&title=TAMUCTF2019 Keygenme — Write-up&summary=Hello everybody! This is how I solved one of the many reversing problems at TAMUCTF 2019.&source=My pentest notes"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on LinkedIn" >
            <i class="fab fa-linkedin share-button"></i>
        </a>

        <a style="text-decoration: none;" href="mailto:?subject=TAMUCTF2019 Keygenme — Write-up&amp;body=Check out this site http://localhost:4000/tamuctf2019-keygenme-write-up/"
            title="Share via Email" >
            <i class="fa fa-envelope share-button"></i>
        </a>
    </div>

</div>
      </div>
      
    </div>
  </div>

</div>

<div class="footer">
  <h5>© Copyright 2020 - All Rights Reserved - DanP</h5>
</div>


</body>
</html>
